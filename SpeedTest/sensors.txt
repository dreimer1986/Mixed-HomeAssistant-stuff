template:
- sensor:
  - name: 'SpeedTest CLI Ping'
    unique_id: speedtest_cli_ping
    icon: mdi:speedometer
    unit_of_measurement: ms
    device_class: DURATION
    state: "{{ (states('sensor.speedtest_cli_data') | from_json).ping | round(2) }}"
  - name: 'SpeedTest CLI Download'
    unique_id: speedtest_cli_download
    icon: mdi:speedometer
    unit_of_measurement: Mbit/s
    device_class: DATA_RATE
    state: "{{ ((states('sensor.speedtest_cli_data') | from_json).download * 8 / 1000 / 1000) | round(2) }}"
  - name: 'SpeedTest CLI Upload'
    unique_id: speedtest_cli_upload
    icon: mdi:speedometer
    unit_of_measurement: Mbit/s
    device_class: DATA_RATE
    state: "{{ ((states('sensor.speedtest_cli_data') | from_json).upload * 8 / 1000 / 1000) | round(2) }}"

command_line:
  - sensor:
      name: "SpeedTest CLI Data"
      unique_id: speedtest_cli_data
      command: "/config/3rdparty/speedtest/speedtest --format=json --accept-license --accept-gdpr"
      scan_interval: 600
      command_timeout: 60
      value_template: >-
        {{
          {
            "ping": value_json.ping.latency,
            "download": value_json.download.bandwidth,
            "upload": value_json.upload.bandwidth
          }
          | to_json
        }}
